#include "stdlib.h"
#include "stdint.h"
#include "stdio.h"
#include "emscripten.h"
#include "../include/rnnoise.h"

#define FRAME_SIZE 480


EMSCRIPTEN_KEEPALIVE
DenoiseState* demo()
{
    DenoiseState* ds;
    return ds;
}

EMSCRIPTEN_KEEPALIVE
uint8_t* create_buffer(int framesize, int numframes)
{
    return malloc(sizeof(uint8_t) * framesize * numframes);
}

EMSCRIPTEN_KEEPALIVE
void destroy_buffer(uint8_t* p)
{
    free(p);
}

// EMSCRIPTEN_KEEPALIVE
// void apply_noise_reduction(short *inaudio, short* outsignal, int frame_count)
// {
//   float x[FRAME_SIZE];
//   DenoiseState *st;
//   int i;

//   st = rnnoise_create();

//   while( frame_count > 0)
//   {
//     for(i = 0; i<FRAME_SIZE; ++i)
//     {
//       x[i] = (float)(*inaudio); 
//       inaudio++;
//     }

//     rnnoise_process_frame(st, x, x);

//     for(i = 0; i<FRAME_SIZE; ++i)
//     {
//       *outsignal = x[i];
//       outsignal++;
//     }
//     frame_count--;
//   }
//   rnnoise_destroy(st);
// }

// EMSCRIPTEN_KEEPALIVE
// int demo() {

//   short tmp[FRAME_SIZE] = {18770, 17990, -28540, 2, 16727, 17750, 28006, 8308, 16, 0, 1, 1, 8000, 0, 16000, 0, 2, 16, 24932, 24948, -28680, 2, 12, 18, 12, 16, 19, 19, 8, 5, -4, -9, -19, -21, -30, -24, -31, -26, -25, -16, 6, 13, 32, 41, 45, 53, 26, 19, -15, -20, -48, -60, -84, -102, -124, -114, -91, -72, -39, -36, -2, -5, -3, -22, -26, -5, 20, 39, 99, 165, 204, 209, 199, 178, 118, 45, -18, -67, -127, -146, -150, -111, -78, -37, -38, -17, 26, 42, 69, 91, 177, 219, 226, 203, 177, 148, 97, 76, 51, 76, 107, 169, 215, 269, 368, 390, 395, 385, 301, 209, 127, 102, 89, 119, 202, 277, 308, 313, 344, 377, 411, 444, 440, 322, 193, 115, -28, -145, -220, -228, -285, -264, -212, -132, -104, -92, -31, 51, 133, 174, 145, 32, -33, -143, -339, -522, -648, -654, -623, -501, -365, -246, -51, 56, 153, 126, 30, -74, -151, -295, -376, -538, -681, -658, -628, -514, -407, -472, -447, -621, -682, -639, -807, -575, -527, -141, 227, 665, 1030, 1299, 1728, 2040, 2421, 2463, 2334, 2031, 1551, 944, 343, -66, -325, -602, -602, -377, 42, 188, 490, 552, 572, 494, 160, 424, 438, 464, 324, 238, 186, 151, 118, 91, 264, 136, 18, -183, -165, -69, -161, -272, -535, -678, -730, -882, -942, -810, -786, -657, -621, -399, 3, 336, 655, 724, 708, 667, 549, 407, 393, 144, 242, 265, 610, 948, 805, 883, 812, 706, 537, 322, 8, 46, -256, -130, -10, 223, 937, 1370, 1600, 1608, 1576, 1606, 1511, 924, 340, -368, -537, -904, -1015, -1190, -1262, -1307, -1279, -1146, -947, -177, 286, 751, 884, 878, 615, 401, -114, -490, -797, -1184, -1308, -1647, -1881, -2190, -3013, -3243, -3065, -2948, -2323, -2141, -1748, -1405, -1397, -1146, -1150, -825, -263, 157, 883, 1742, 2198, 2448, 2471, 2066, 1813, 861, 62, -389, -888, -1210, -1398, -1236, -1088, -754, -408, 248, 609, 886, 1136, 1354, 1656, 1895, 2362, 2737, 3099, 3364, 3445, 3348, 2932, 2683, 2547, 2528, 2256, 1765, 1356, 827, 79, -720, -1528, -2006, -2263, -2618, -2536, -2260, -1482, -945, -429, 312, 919, 1398, 1796, 2022, 2067, 1763, 1043, 704, 240, -100, -999, -1611, -1658, -1772, -1971, -2693, -3045, -3191, -3499, -3225, -2612, -1531, -414, 803, 1814, 2514, 2876, 2370, 1836, 858, 161, -820, -1780, -2235, -2804, -3292, -3741, -3704, -3268, -2661, -1592, -440, 842, 2384, 3171, 3681, 3556, 2993, 2614, 1991, 1257, 649, 265, -141, -745, -1631, -2326, -3223, -4078, -4460, -4389, -3765, -2819, -2074, -1095, 504, 1368, 1441, 1387, 1321, 1059, 704, 295, 155, 155, 178, -147, -332, -618, -930, -985, -979, -617, -13, 266, 208, 295, -181, -812, -1670, -2195, -2521, -2315, -1556, -963, -250, 293, 288, -33, -121, -211, -317, -179, -48, 287, 308, -214, -247, -694, -1361, -1372, -851, -140, 639, 1272, 1787, 2592, 3360, 3679, 3518, 2407, 900, -522, -1715, -2285, -2428, -2006, -1274};
//   int frame_count = 1;
//   short *xx = (short *) malloc(sizeof(short) * FRAME_SIZE * frame_count);
//   // short *xy = (short *) malloc(sizeof(short) * FRAME_SIZE * FRAME_COUNT);
  
//   for (int i=0;i<FRAME_SIZE * frame_count;i++) {xx[i] = tmp[i]; }

//   apply_noise_reduction(xx, xx, frame_count);

//   for(int i=0;i<FRAME_SIZE * frame_count;++i) printf("%d, ", *(xx++));

//   printf("\n");

//   // free(xx);

//   return 0;
// }
//expected
//0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, -1, 0, 0, -1, 0, -1, 0, -1, 0, 0, -1, 0, -1, 0, 0, -1, 1, -1, 1, 0, 0, 1, -1, 1, -1, 0, 0, -1, 1, -2, 0, -1, -1, 0, -3, 0, -3, -1, -1, -3, 0, -4, 0, -2, -2, 0, -3, 1, -2, 0, 0, -2, 3, -2, 3, 0, 0, 4, -1, 5, 0, 2, 3, -1, 5, -2, 4, 0, 0, 3, -4, 4, -3, 0, 0, -4, 4, -5, 3, 0, -1, 5, -3, 7, 0, 3, 4, -1, 8, -2, 5, 0, -1, 5, -6, 5, -4, 0, 1, -7, 5, -8, 2, -2, -5, 3, -9, 4, -5, -1, 2, -7, 7, -6, 5, 1, -1, 10, -4, 11, 0, 4, 9, -2, 14, -3, 9, 4, -1, 11, -7, 9, -4, -1, 3, -11, 7, -12, 0, -4, -11, 4, -15, 4, -9, -4, 2, -13, 9, -11, 3, 0, -7, 10, -12, 10, -4, 0, 8, -10, 15, -8, 7, 3, -6, 13, -12, 11, -5, -2, 7, -14, 14, -11, 4, 1, -9, 14, -12, 15, -1, 1, 15, -8, 23, -3, 14, 12, 0, 25, -6, 22, 4, 5, 20, -8, 25, -4, 13, 11, -5, 24, -10, 20, 0, 0, 17, -14, 22, -11, 5, 3, -16, 16, -22, 10, -8, -9, 10, -23, 18, -14, 5, 6, -15, 22, -17, 18, 0, -2, 20, -17, 25, -10, 7, 9, -16, 23, -22, 12, -8, -14, 10, -32, 13, -26, -8, -4, -33, 11, -36, 2, -18, -25, 3, -41, 10, -28, -9, -3, -35, 14, -34, 7, -12, -21, 12, -38, 16, -26, -8, -1, -39, 11, -45, -4, -25, -37, 0, -56, 0, -43, -26, -14, -53, 5, -49, -1, -19, -31, 14, -40, 27, -14, 5, 22, -18, 49, -7, 43, 26, 10, 57, -5, 62, 16, 33, 49, -1, 64, -4, 45, 26, 4, 55, -15, 56, 7, 26, 47, -4, 74, 5, 60, 42, 17, 78, 5, 82, 26, 35, 51, -15, 61, -23, 23, -4, -45, 7, -84, -7, -69, -59, -42, -119, -33, -116, -53, -67, -101, -32, -120, -25, -83, -65, -33, -106, -2, -93, -31, -54, -92, -14, -111, -11, -85, -73, -44, -129, -19, -122, -58, -94, -151, -85, -202, -85, -163, -154, -137, -240, -116, -207, -105, -124, -152, -48, -136, 37, -14, 45, 104, 44, 197, 91, 201, 158, 149, 239, 111, 248, 110, 125, 87, 3, 116, 0, 149, 4, -20, -26, -43, 252, 186, 250, -43, 54, 160, 302, 678, 276, 398, -254, 301, 161, 230, -1210, -1836
